<!DOCTYPE html>
<html>
<head>
    <title>Flux WiFi Sniffer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Flux WiFi Sniffer</h1>

    <button onclick="loadAll()">Refresh</button>

    <h2>Stats</h2>
    <p>Total Devices: <span id="totalDevices">-</span></p>
    <p>Active Devices (5min): <span id="activeDevices">-</span></p>
    <p>Total APs: <span id="totalAPs">-</span></p>
    <p>Active APs (5min): <span id="activeAPs">-</span></p>

    <hr>

    <h2>Active Devices</h2>
    <p>
        <label><input type="checkbox" id="allowlistMode" onchange="toggleAllowlistMode()"> Allowlist Mode (show only approved devices)</label>
    </p>
    <div id="allowlistEditor" style="display:none;">
        <p><strong>Approved MAC Addresses (one per line):</strong></p>
        <textarea id="allowlistInput" rows="10" cols="50" placeholder="00:11:22:33:44:55&#10;aa:bb:cc:dd:ee:ff"></textarea>
        <br>
        <button onclick="saveAllowlist()">Save Allowlist</button>
        <button onclick="toggleEditor()">Hide Editor</button>
    </div>
    <p>
        <button onclick="toggleEditor()">Edit Allowlist</button>
        <span id="allowlistStatus"></span>
    </p>
    <input type="text" id="deviceSearch" placeholder="Search devices..." onkeyup="filterDevices()">
    <table border="1" id="devicesTable">
        <thead>
            <tr>
                <th onclick="sortDevices('mac_address')">MAC Address</th>
                <th onclick="sortDevices('vendor')">Vendor</th>
                <th onclick="sortDevices('connected')">Status</th>
                <th onclick="sortDevices('probe_ssids')">Probe SSIDs</th>
                <th onclick="sortDevices('data_bytes')">Data Usage</th>
                <th onclick="sortDevices('last_seen')">Last Seen</th>
                <th onclick="sortDevices('packet_count')">Packets</th>
                <th onclick="sortDevices('rssi')">Avg RSSI</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Access Points</h2>
    <input type="text" id="apSearch" placeholder="Search APs..." onkeyup="filterAPs()">
    <table border="1" id="apsTable">
        <thead>
            <tr>
                <th onclick="sortAPs('ssid')">SSID</th>
                <th onclick="sortAPs('bssid')">BSSID</th>
                <th onclick="sortAPs('channel')">Channel</th>
                <th onclick="sortAPs('encryption')">Encryption</th>
                <th onclick="sortAPs('last_seen')">Last Seen</th>
                <th onclick="sortAPs('beacon_count')">Beacons</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>
    <p>Last updated: <span id="lastUpdate">-</span></p>

    <script>
        const API_BASE = '';
        let devicesData = [];
        let apsData = [];
        let deviceSortKey = 'last_seen';
        let deviceSortAsc = false;
        let apSortKey = 'last_seen';
        let apSortAsc = false;
        let allowlist = [];
        let allowlistEnabled = false;

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        function avgRSSI(values) {
            if (!values || values.length === 0) return '-';
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return avg.toFixed(0) + ' dBm';
        }

        function avgRSSIValue(values) {
            if (!values || values.length === 0) return -999;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        async function loadStats() {
            const res = await fetch(API_BASE + '/stats');
            const data = await res.json();
            document.getElementById('totalDevices').textContent = data.total_devices;
            document.getElementById('activeDevices').textContent = data.active_devices;
            document.getElementById('totalAPs').textContent = data.total_aps;
            document.getElementById('activeAPs').textContent = data.active_aps;
        }

        async function loadDevices() {
            const res = await fetch(API_BASE + '/devices/active?minutes=5');
            devicesData = await res.json();
            renderDevices();
        }

        async function loadAPs() {
            const res = await fetch(API_BASE + '/access-points?limit=100');
            apsData = await res.json();
            renderAPs();
        }

        function sortDevices(key) {
            if (deviceSortKey === key) {
                deviceSortAsc = !deviceSortAsc;
            } else {
                deviceSortKey = key;
                deviceSortAsc = true;
            }
            renderDevices();
        }

        function sortAPs(key) {
            if (apSortKey === key) {
                apSortAsc = !apSortAsc;
            } else {
                apSortKey = key;
                apSortAsc = true;
            }
            renderAPs();
        }

        function renderDevices() {
            const search = document.getElementById('deviceSearch').value.toLowerCase();
            let filtered = devicesData.filter(d => {
                const matchesSearch = d.mac_address.toLowerCase().includes(search) ||
                    (d.vendor && d.vendor.toLowerCase().includes(search)) ||
                    (d.probe_ssids && d.probe_ssids.some(s => s.toLowerCase().includes(search)));

                if (!matchesSearch) return false;

                if (allowlistEnabled) {
                    return allowlist.some(mac => mac.toLowerCase() === d.mac_address.toLowerCase());
                }

                return true;
            });

            filtered.sort((a, b) => {
                let aVal, bVal;
                if (deviceSortKey === 'rssi') {
                    aVal = avgRSSIValue(a.rssi_values);
                    bVal = avgRSSIValue(b.rssi_values);
                } else if (deviceSortKey === 'probe_ssids') {
                    aVal = a.probe_ssids ? a.probe_ssids.join(',') : '';
                    bVal = b.probe_ssids ? b.probe_ssids.join(',') : '';
                } else {
                    aVal = a[deviceSortKey] || '';
                    bVal = b[deviceSortKey] || '';
                }

                if (aVal < bVal) return deviceSortAsc ? -1 : 1;
                if (aVal > bVal) return deviceSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('devicesTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(d => `
                <tr>
                    <td>${d.mac_address}</td>
                    <td>${d.vendor || '-'}</td>
                    <td>${d.connected ? '<b>CONNECTED</b>' : 'Probing'}</td>
                    <td>${d.probe_ssids && d.probe_ssids.length > 0 ? d.probe_ssids.join(', ') : '-'}</td>
                    <td>${formatBytes(d.data_bytes || 0)}</td>
                    <td>${formatTime(d.last_seen)}</td>
                    <td>${d.packet_count || 0}</td>
                    <td>${avgRSSI(d.rssi_values)}</td>
                </tr>
            `).join('');
        }

        function renderAPs() {
            const search = document.getElementById('apSearch').value.toLowerCase();
            let filtered = apsData.filter(ap =>
                (ap.ssid && ap.ssid.toLowerCase().includes(search)) ||
                ap.bssid.toLowerCase().includes(search)
            );

            filtered.sort((a, b) => {
                let aVal = a[apSortKey] || '';
                let bVal = b[apSortKey] || '';

                if (aVal < bVal) return apSortAsc ? -1 : 1;
                if (aVal > bVal) return apSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('apsTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(ap => `
                <tr>
                    <td>${ap.ssid || '(hidden)'}</td>
                    <td>${ap.bssid}</td>
                    <td>${ap.channel || '-'}</td>
                    <td>${ap.encryption || '-'}</td>
                    <td>${formatTime(ap.last_seen)}</td>
                    <td>${ap.beacon_count || 0}</td>
                </tr>
            `).join('');
        }

        function filterDevices() {
            renderDevices();
        }

        function filterAPs() {
            renderAPs();
        }

        function toggleAllowlistMode() {
            allowlistEnabled = document.getElementById('allowlistMode').checked;
            updateAllowlistStatus();
            renderDevices();
        }

        function toggleEditor() {
            const editor = document.getElementById('allowlistEditor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function saveAllowlist() {
            const input = document.getElementById('allowlistInput').value;
            allowlist = input.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            localStorage.setItem('flux_allowlist', JSON.stringify(allowlist));
            updateAllowlistStatus();
            renderDevices();
            alert('Allowlist saved with ' + allowlist.length + ' MAC addresses');
        }

        function loadAllowlist() {
            const stored = localStorage.getItem('flux_allowlist');
            if (stored) {
                allowlist = JSON.parse(stored);
                document.getElementById('allowlistInput').value = allowlist.join('\n');
            }
            updateAllowlistStatus();
        }

        function updateAllowlistStatus() {
            const status = document.getElementById('allowlistStatus');
            if (allowlist.length > 0) {
                status.textContent = '(' + allowlist.length + ' approved MACs)';
            } else {
                status.textContent = '(no MACs configured)';
            }
        }

        async function loadAll() {
            await Promise.all([loadStats(), loadDevices(), loadAPs()]);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }

        loadAllowlist();
        loadAll();
        setInterval(loadAll, 5000);
    </script>
</body>
</html>
