<!DOCTYPE html>
<html>
<head>
    <title>Flux WiFi Sniffer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Flux WiFi Sniffer</h1>

    <button onclick="loadAll()">Refresh</button>

    <h2>Stats</h2>
    <p>Total Devices: <span id="totalDevices">-</span></p>
    <p>Active Devices (5min): <span id="activeDevices">-</span></p>
    <p>Total APs: <span id="totalAPs">-</span></p>
    <p>Active APs (5min): <span id="activeAPs">-</span></p>

    <hr>

    <h2>Channel Hopping Control</h2>
    <p>
        <label>
            <input type="checkbox" id="channelHoppingEnabled" onchange="updateChannelHopping()">
            Enable Channel Hopping
        </label>
    </p>
    <p>
        <label>
            Timeout (ms):
            <input type="number" id="channelHoppingTimeout" min="50" max="10000" step="50" value="300" onchange="updateChannelHopping()">
        </label>
        (50-10000ms)
    </p>
    <p>Status: <span id="channelHoppingStatus">-</span></p>

    <hr>

    <h2>Active Devices</h2>
    <p>
        <label><input type="checkbox" id="allowlistMode" onchange="toggleAllowlistMode()"> Allowlist Mode (show only approved devices)</label>
    </p>
    <div id="allowlistEditor" style="display:none;">
        <p><strong>Approved MAC Addresses (one per line):</strong></p>
        <textarea id="allowlistInput" rows="10" cols="50" placeholder="00:11:22:33:44:55&#10;aa:bb:cc:dd:ee:ff"></textarea>
        <br>
        <button onclick="saveAllowlist()">Save Allowlist</button>
        <button onclick="toggleEditor()">Hide Editor</button>
    </div>
    <p>
        <button onclick="toggleEditor()">Edit Allowlist</button>
        <span id="allowlistStatus"></span>
    </p>
    <input type="text" id="deviceSearch" placeholder="Search devices..." onkeyup="filterDevices()">
    <table border="1" id="devicesTable">
        <thead>
            <tr>
                <th onclick="sortDevices('mac_address')">MAC Address</th>
                <th onclick="sortDevices('vendor')">Vendor</th>
                <th onclick="sortDevices('connected')">Status</th>
                <th onclick="sortDevices('probe_ssids')">Probe SSIDs</th>
                <th onclick="sortDevices('data_bytes')">Data Usage</th>
                <th onclick="sortDevices('last_seen')">Last Seen</th>
                <th onclick="sortDevices('packet_count')">Packets</th>
                <th onclick="sortDevices('rssi')">Avg RSSI</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Access Points</h2>
    <input type="text" id="apSearch" placeholder="Search APs..." onkeyup="filterAPs()">
    <table border="1" id="apsTable">
        <thead>
            <tr>
                <th onclick="sortAPs('ssid')">SSID</th>
                <th onclick="sortAPs('bssid')">BSSID</th>
                <th onclick="sortAPs('channel')">Channel</th>
                <th onclick="sortAPs('encryption')">Encryption</th>
                <th onclick="sortAPs('last_seen')">Last Seen</th>
                <th onclick="sortAPs('beacon_count')">Beacons</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Historical Data</h2>
    <div>
        <label>Time Range:
            <select id="historyRange" onchange="loadHistoricalData()">
                <option value="1">Last Hour</option>
                <option value="6">Last 6 Hours</option>
                <option value="24" selected>Last 24 Hours</option>
                <option value="72">Last 3 Days</option>
                <option value="168">Last 7 Days</option>
            </select>
        </label>
        <label style="margin-left: 20px;">Granularity:
            <select id="historyTier" onchange="loadHistoricalData()">
                <option value="1m">1 minute</option>
                <option value="5m">5 minutes</option>
                <option value="1h" selected>1 hour</option>
            </select>
        </label>
        <button onclick="loadHistoricalData()" style="margin-left: 20px;">Refresh History</button>
    </div>

    <h3>Summary Statistics</h3>
    <div id="historySummary">
        <p>Loading...</p>
    </div>

    <h3>Device & AP Trends</h3>
    <div id="historyChart">
        <p>Loading chart...</p>
    </div>

    <h3>Recent Snapshots</h3>
    <table border="1" id="historyTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Total Devices</th>
                <th>Active Devices</th>
                <th>Connected</th>
                <th>Total APs</th>
                <th>Active APs</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="6">Loading...</td></tr>
        </tbody>
    </table>

    <hr>
    <p>Last updated: <span id="lastUpdate">-</span></p>

    <script>
        const API_BASE = '';
        let devicesData = [];
        let apsData = [];
        let deviceSortKey = 'last_seen';
        let deviceSortAsc = false;
        let apSortKey = 'last_seen';
        let apSortAsc = false;
        let allowlist = [];
        let allowlistEnabled = false;

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        function avgRSSI(values) {
            if (!values || values.length === 0) return '-';
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return avg.toFixed(0) + ' dBm';
        }

        function avgRSSIValue(values) {
            if (!values || values.length === 0) return -999;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        async function loadStats() {
            const res = await fetch(API_BASE + '/stats');
            const data = await res.json();
            document.getElementById('totalDevices').textContent = data.total_devices;
            document.getElementById('activeDevices').textContent = data.active_devices;
            document.getElementById('totalAPs').textContent = data.total_aps;
            document.getElementById('activeAPs').textContent = data.active_aps;
        }

        async function loadDevices() {
            const res = await fetch(API_BASE + '/devices/active?minutes=5');
            devicesData = await res.json();
            renderDevices();
        }

        async function loadAPs() {
            const res = await fetch(API_BASE + '/access-points?limit=100');
            apsData = await res.json();
            renderAPs();
        }

        function sortDevices(key) {
            if (deviceSortKey === key) {
                deviceSortAsc = !deviceSortAsc;
            } else {
                deviceSortKey = key;
                deviceSortAsc = true;
            }
            renderDevices();
        }

        function sortAPs(key) {
            if (apSortKey === key) {
                apSortAsc = !apSortAsc;
            } else {
                apSortKey = key;
                apSortAsc = true;
            }
            renderAPs();
        }

        function renderDevices() {
            const search = document.getElementById('deviceSearch').value.toLowerCase();
            let filtered = devicesData.filter(d => {
                const matchesSearch = d.mac_address.toLowerCase().includes(search) ||
                    (d.vendor && d.vendor.toLowerCase().includes(search)) ||
                    (d.probe_ssids && d.probe_ssids.some(s => s.toLowerCase().includes(search)));

                if (!matchesSearch) return false;

                if (allowlistEnabled) {
                    return allowlist.some(mac => mac.toLowerCase() === d.mac_address.toLowerCase());
                }

                return true;
            });

            filtered.sort((a, b) => {
                let aVal, bVal;
                if (deviceSortKey === 'rssi') {
                    aVal = avgRSSIValue(a.rssi_values);
                    bVal = avgRSSIValue(b.rssi_values);
                } else if (deviceSortKey === 'probe_ssids') {
                    aVal = a.probe_ssids ? a.probe_ssids.join(',') : '';
                    bVal = b.probe_ssids ? b.probe_ssids.join(',') : '';
                } else {
                    aVal = a[deviceSortKey] || '';
                    bVal = b[deviceSortKey] || '';
                }

                if (aVal < bVal) return deviceSortAsc ? -1 : 1;
                if (aVal > bVal) return deviceSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('devicesTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(d => `
                <tr>
                    <td>${d.mac_address}</td>
                    <td>${d.vendor || '-'}</td>
                    <td>${d.connected ? '<b>CONNECTED</b>' : 'Probing'}</td>
                    <td>${d.probe_ssids && d.probe_ssids.length > 0 ? d.probe_ssids.join(', ') : '-'}</td>
                    <td>${formatBytes(d.data_bytes || 0)}</td>
                    <td>${formatTime(d.last_seen)}</td>
                    <td>${d.packet_count || 0}</td>
                    <td>${avgRSSI(d.rssi_values)}</td>
                </tr>
            `).join('');
        }

        function renderAPs() {
            const search = document.getElementById('apSearch').value.toLowerCase();
            let filtered = apsData.filter(ap =>
                (ap.ssid && ap.ssid.toLowerCase().includes(search)) ||
                ap.bssid.toLowerCase().includes(search)
            );

            filtered.sort((a, b) => {
                let aVal = a[apSortKey] || '';
                let bVal = b[apSortKey] || '';

                if (aVal < bVal) return apSortAsc ? -1 : 1;
                if (aVal > bVal) return apSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('apsTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(ap => `
                <tr>
                    <td>${ap.ssid || '(hidden)'}</td>
                    <td>${ap.bssid}</td>
                    <td>${ap.channel || '-'}</td>
                    <td>${ap.encryption || '-'}</td>
                    <td>${formatTime(ap.last_seen)}</td>
                    <td>${ap.beacon_count || 0}</td>
                </tr>
            `).join('');
        }

        function filterDevices() {
            renderDevices();
        }

        function filterAPs() {
            renderAPs();
        }

        function toggleAllowlistMode() {
            allowlistEnabled = document.getElementById('allowlistMode').checked;
            updateAllowlistStatus();
            renderDevices();
        }

        function toggleEditor() {
            const editor = document.getElementById('allowlistEditor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function saveAllowlist() {
            const input = document.getElementById('allowlistInput').value;
            allowlist = input.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            localStorage.setItem('flux_allowlist', JSON.stringify(allowlist));
            updateAllowlistStatus();
            renderDevices();
            alert('Allowlist saved with ' + allowlist.length + ' MAC addresses');
        }

        function loadAllowlist() {
            const stored = localStorage.getItem('flux_allowlist');
            if (stored) {
                allowlist = JSON.parse(stored);
                document.getElementById('allowlistInput').value = allowlist.join('\n');
            }
            updateAllowlistStatus();
        }

        function updateAllowlistStatus() {
            const status = document.getElementById('allowlistStatus');
            if (allowlist.length > 0) {
                status.textContent = '(' + allowlist.length + ' approved MACs)';
            } else {
                status.textContent = '(no MACs configured)';
            }
        }

        async function loadChannelConfig() {
            try {
                const res = await fetch(API_BASE + '/config/channel-hopping');
                const data = await res.json();
                document.getElementById('channelHoppingEnabled').checked = data.enabled;
                document.getElementById('channelHoppingTimeout').value = data.timeout_ms;
                updateChannelStatus(data);
            } catch (err) {
                console.error('Failed to load channel config:', err);
                document.getElementById('channelHoppingStatus').textContent = 'Error loading config';
            }
        }

        async function updateChannelHopping() {
            const enabled = document.getElementById('channelHoppingEnabled').checked;
            const timeoutMs = parseInt(document.getElementById('channelHoppingTimeout').value);

            if (timeoutMs < 50 || timeoutMs > 10000) {
                alert('Timeout must be between 50 and 10000ms');
                return;
            }

            try {
                const res = await fetch(API_BASE + '/config/channel-hopping', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        enabled: enabled,
                        timeout_ms: timeoutMs
                    })
                });
                const data = await res.json();
                if (data.status === 'ok') {
                    updateChannelStatus(data.config);
                } else {
                    alert('Failed to update config: ' + (data.error || 'unknown error'));
                }
            } catch (err) {
                console.error('Failed to update channel config:', err);
                alert('Failed to update config: ' + err.message);
            }
        }

        function updateChannelStatus(config) {
            const status = document.getElementById('channelHoppingStatus');
            if (config.enabled) {
                status.textContent = 'Enabled, hopping every ' + config.timeout_ms + 'ms';
            } else {
                status.textContent = 'Disabled';
            }
        }

        async function loadAll() {
            await Promise.all([loadStats(), loadDevices(), loadAPs(), loadChannelConfig()]);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }

        async function loadHistoricalData() {
            const hours = parseInt(document.getElementById('historyRange').value);
            const tier = document.getElementById('historyTier').value;

            const end = new Date();
            const start = new Date(end.getTime() - (hours * 60 * 60 * 1000));

            const startStr = start.toISOString();
            const endStr = end.toISOString();

            // Load summary
            try {
                const summaryRes = await fetch(`${API_BASE}/metrics/summary?tier=${tier}&start=${startStr}&end=${endStr}`);
                const summaryData = await summaryRes.json();
                renderHistorySummary(summaryData);
            } catch (e) {
                document.getElementById('historySummary').innerHTML = '<p>Error loading summary: ' + e.message + '</p>';
            }

            // Load history snapshots
            try {
                const historyRes = await fetch(`${API_BASE}/metrics/history?tier=${tier}&start=${startStr}&end=${endStr}&limit=100`);
                const historyData = await historyRes.json();
                renderHistoryTable(historyData.snapshots || []);
                renderHistoryChart(historyData.snapshots || [], tier);
            } catch (e) {
                document.getElementById('historyTable').querySelector('tbody').innerHTML =
                    '<tr><td colspan="6">Error loading history: ' + e.message + '</td></tr>';
            }
        }

        function renderHistorySummary(data) {
            if (data.error) {
                document.getElementById('historySummary').innerHTML = '<p>' + data.error + '</p>';
                return;
            }

            const html = `
                <table border="1">
                    <tr>
                        <th colspan="2">Devices</th>
                        <th colspan="2">Access Points</th>
                    </tr>
                    <tr>
                        <td><b>Avg Total:</b> ${data.devices.avg_total.toFixed(1)}</td>
                        <td><b>Avg Active:</b> ${data.devices.avg_active.toFixed(1)}</td>
                        <td><b>Avg Total:</b> ${data.access_points.avg_total.toFixed(1)}</td>
                        <td><b>Avg Active:</b> ${data.access_points.avg_active.toFixed(1)}</td>
                    </tr>
                    <tr>
                        <td><b>Max Total:</b> ${data.devices.max_total}</td>
                        <td><b>Max Active:</b> ${data.devices.max_active}</td>
                        <td><b>Max Total:</b> ${data.access_points.max_total}</td>
                        <td><b>Max Active:</b> ${data.access_points.max_active}</td>
                    </tr>
                    <tr>
                        <td colspan="2"><b>Avg Connected:</b> ${data.devices.avg_connected.toFixed(1)}</td>
                        <td colspan="2"><b>Data Points:</b> ${data.data_points}</td>
                    </tr>
                </table>
            `;
            document.getElementById('historySummary').innerHTML = html;
        }

        function renderHistoryTable(snapshots) {
            if (!snapshots || snapshots.length === 0) {
                document.getElementById('historyTable').querySelector('tbody').innerHTML =
                    '<tr><td colspan="6">No historical data available</td></tr>';
                return;
            }

            // Show most recent 20 snapshots
            const recent = snapshots.slice(0, 20);

            const tbody = document.getElementById('historyTable').querySelector('tbody');
            tbody.innerHTML = recent.map(snap => `
                <tr>
                    <td>${formatTime(snap.timestamp)}</td>
                    <td>${snap.devices.total}</td>
                    <td>${snap.devices.active}</td>
                    <td>${snap.devices.connected}</td>
                    <td>${snap.access_points.total}</td>
                    <td>${snap.access_points.active}</td>
                </tr>
            `).join('');
        }

        function renderHistoryChart(snapshots, tier) {
            if (!snapshots || snapshots.length === 0) {
                document.getElementById('historyChart').innerHTML = '<p>No data available for chart</p>';
                return;
            }

            // Reverse to show oldest first (left to right)
            const data = snapshots.slice().reverse();

            // Find max values for scaling
            const maxDevices = Math.max(...data.map(s => s.devices.active), 1);
            const maxAPs = Math.max(...data.map(s => s.access_points.active), 1);
            const maxValue = Math.max(maxDevices, maxAPs, 1);

            const chartHeight = 20;
            const barChar = '█';
            const emptyChar = '·';

            let chart = '<pre style="line-height: 1.2;">\n';
            chart += `Active Devices & APs Over Time (${tier} intervals)\n`;
            chart += `Legend: Devices=${barChar} APs=${emptyChar}\n\n`;

            // Create chart rows (top to bottom)
            for (let row = chartHeight; row >= 0; row--) {
                const threshold = (row / chartHeight) * maxValue;
                const label = row === chartHeight ? maxValue.toFixed(0) :
                             row === 0 ? '0' : '';
                chart += label.padStart(4) + ' │';

                for (let i = 0; i < Math.min(data.length, 50); i++) {
                    const devActive = data[i].devices.active;
                    const apActive = data[i].access_points.active;

                    if (devActive >= threshold) {
                        chart += barChar;
                    } else if (apActive >= threshold) {
                        chart += emptyChar;
                    } else {
                        chart += ' ';
                    }
                }
                chart += '\n';
            }

            // X-axis
            chart += '     └' + '─'.repeat(Math.min(data.length, 50)) + '\n';

            // Time labels (show first and last)
            if (data.length > 0) {
                const firstTime = new Date(data[0].timestamp).toLocaleTimeString();
                const lastTime = new Date(data[data.length - 1].timestamp).toLocaleTimeString();
                chart += `      ${firstTime}`;
                chart += ' '.repeat(Math.max(0, Math.min(data.length, 50) - firstTime.length - lastTime.length));
                chart += `${lastTime}\n`;
            }

            chart += '\n';
            chart += `Total snapshots: ${snapshots.length} | Showing: ${Math.min(data.length, 50)}\n`;
            chart += '</pre>';

            document.getElementById('historyChart').innerHTML = chart;
        }

        loadAllowlist();
        loadAll();
        loadHistoricalData();
        setInterval(loadAll, 5000);
        setInterval(loadHistoricalData, 60000); // Refresh history every minute
    </script>
</body>
</html>
