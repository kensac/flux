<!DOCTYPE html>
<html>
<head>
    <title>Flux WiFi Sniffer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Flux WiFi Sniffer</h1>

    <button onclick="loadAll()">Refresh</button>

    <h2>Stats</h2>
    <p>Total Devices: <span id="totalDevices">-</span></p>
    <p>Active Devices (5min): <span id="activeDevices">-</span></p>
    <p>Total APs: <span id="totalAPs">-</span></p>
    <p>Active APs (5min): <span id="activeAPs">-</span></p>

    <hr>

    <h2>Active Devices</h2>
    <input type="text" id="deviceSearch" placeholder="Search devices..." onkeyup="filterDevices()">
    <table border="1" id="devicesTable">
        <thead>
            <tr>
                <th onclick="sortDevices('mac_address')">MAC Address</th>
                <th onclick="sortDevices('vendor')">Vendor</th>
                <th onclick="sortDevices('probe_ssids')">Probe SSIDs</th>
                <th onclick="sortDevices('last_seen')">Last Seen</th>
                <th onclick="sortDevices('packet_count')">Packets</th>
                <th onclick="sortDevices('rssi')">Avg RSSI</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Access Points</h2>
    <input type="text" id="apSearch" placeholder="Search APs..." onkeyup="filterAPs()">
    <table border="1" id="apsTable">
        <thead>
            <tr>
                <th onclick="sortAPs('ssid')">SSID</th>
                <th onclick="sortAPs('bssid')">BSSID</th>
                <th onclick="sortAPs('channel')">Channel</th>
                <th onclick="sortAPs('encryption')">Encryption</th>
                <th onclick="sortAPs('last_seen')">Last Seen</th>
                <th onclick="sortAPs('beacon_count')">Beacons</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr>
    <p>Last updated: <span id="lastUpdate">-</span></p>

    <script>
        const API_BASE = '';
        let devicesData = [];
        let apsData = [];
        let deviceSortKey = 'last_seen';
        let deviceSortAsc = false;
        let apSortKey = 'last_seen';
        let apSortAsc = false;

        function formatTime(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.toLocaleString();
        }

        function avgRSSI(values) {
            if (!values || values.length === 0) return '-';
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return avg.toFixed(0) + ' dBm';
        }

        function avgRSSIValue(values) {
            if (!values || values.length === 0) return -999;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        async function loadStats() {
            const res = await fetch(API_BASE + '/stats');
            const data = await res.json();
            document.getElementById('totalDevices').textContent = data.total_devices;
            document.getElementById('activeDevices').textContent = data.active_devices;
            document.getElementById('totalAPs').textContent = data.total_aps;
            document.getElementById('activeAPs').textContent = data.active_aps;
        }

        async function loadDevices() {
            const res = await fetch(API_BASE + '/devices/active?minutes=5');
            devicesData = await res.json();
            renderDevices();
        }

        async function loadAPs() {
            const res = await fetch(API_BASE + '/access-points?limit=100');
            apsData = await res.json();
            renderAPs();
        }

        function sortDevices(key) {
            if (deviceSortKey === key) {
                deviceSortAsc = !deviceSortAsc;
            } else {
                deviceSortKey = key;
                deviceSortAsc = true;
            }
            renderDevices();
        }

        function sortAPs(key) {
            if (apSortKey === key) {
                apSortAsc = !apSortAsc;
            } else {
                apSortKey = key;
                apSortAsc = true;
            }
            renderAPs();
        }

        function renderDevices() {
            const search = document.getElementById('deviceSearch').value.toLowerCase();
            let filtered = devicesData.filter(d =>
                d.mac_address.toLowerCase().includes(search) ||
                (d.vendor && d.vendor.toLowerCase().includes(search)) ||
                (d.probe_ssids && d.probe_ssids.some(s => s.toLowerCase().includes(search)))
            );

            filtered.sort((a, b) => {
                let aVal, bVal;
                if (deviceSortKey === 'rssi') {
                    aVal = avgRSSIValue(a.rssi_values);
                    bVal = avgRSSIValue(b.rssi_values);
                } else if (deviceSortKey === 'probe_ssids') {
                    aVal = a.probe_ssids ? a.probe_ssids.join(',') : '';
                    bVal = b.probe_ssids ? b.probe_ssids.join(',') : '';
                } else {
                    aVal = a[deviceSortKey] || '';
                    bVal = b[deviceSortKey] || '';
                }

                if (aVal < bVal) return deviceSortAsc ? -1 : 1;
                if (aVal > bVal) return deviceSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('devicesTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(d => `
                <tr>
                    <td>${d.mac_address}</td>
                    <td>${d.vendor || '-'}</td>
                    <td>${d.probe_ssids && d.probe_ssids.length > 0 ? d.probe_ssids.join(', ') : '-'}</td>
                    <td>${formatTime(d.last_seen)}</td>
                    <td>${d.packet_count || 0}</td>
                    <td>${avgRSSI(d.rssi_values)}</td>
                </tr>
            `).join('');
        }

        function renderAPs() {
            const search = document.getElementById('apSearch').value.toLowerCase();
            let filtered = apsData.filter(ap =>
                (ap.ssid && ap.ssid.toLowerCase().includes(search)) ||
                ap.bssid.toLowerCase().includes(search)
            );

            filtered.sort((a, b) => {
                let aVal = a[apSortKey] || '';
                let bVal = b[apSortKey] || '';

                if (aVal < bVal) return apSortAsc ? -1 : 1;
                if (aVal > bVal) return apSortAsc ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('apsTable').querySelector('tbody');
            tbody.innerHTML = filtered.map(ap => `
                <tr>
                    <td>${ap.ssid || '(hidden)'}</td>
                    <td>${ap.bssid}</td>
                    <td>${ap.channel || '-'}</td>
                    <td>${ap.encryption || '-'}</td>
                    <td>${formatTime(ap.last_seen)}</td>
                    <td>${ap.beacon_count || 0}</td>
                </tr>
            `).join('');
        }

        function filterDevices() {
            renderDevices();
        }

        function filterAPs() {
            renderAPs();
        }

        async function loadAll() {
            await Promise.all([loadStats(), loadDevices(), loadAPs()]);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        }

        loadAll();
        setInterval(loadAll, 5000);
    </script>
</body>
</html>
